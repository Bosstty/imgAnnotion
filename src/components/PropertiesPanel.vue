<template>
    <div>
        <!-- ÊäòÂè†Áä∂ÊÄÅÁöÑÈù¢ÊùøËæπÊù° -->
        <div class="properties-collapsed" :class="{ expanded: !isCollapsed }" @click="togglePanel">
            <!-- ÊäòÂè†Áä∂ÊÄÅÊòæÁ§∫ÁöÑÂÜÖÂÆπ -->
            <div class="collapsed-content">
                <!-- Â±ûÊÄßÂõæÊ†áÊåáÁ§∫Âô® -->
                <div class="collapsed-icon">üìã</div>

                <!-- Á±ªÂà´È¢úËâ≤ÊåáÁ§∫Âô® -  -->
                <div class="collapsed-categories">
                    <div
                        v-for="category in categories"
                        :key="category.id"
                        class="collapsed-category-item"
                        :class="{ active: selectedCategoryId === category.id }"
                        @click.stop="selectCategory(category.id)"
                    >
                        <div
                            class="collapsed-category-dot"
                            :style="{ background: category.color }"
                        ></div>
                        <div class="collapsed-category-name">{{ category.name }}</div>
                    </div>
                </div>

                <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                <div class="collapsed-stats">
                    <div class="stat-item">
                        <div class="stat-number">{{ totalAnnotationsCount }}</div>
                        <div class="stat-text">Ê†áÊ≥®</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">{{ annotatedFilesCount }}</div>
                        <div class="stat-text">ÂõæÁâá</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Â±ïÂºÄÁä∂ÊÄÅÁöÑÂÆåÊï¥Èù¢Êùø -->
        <div class="properties-expanded" :class="{ open: !isCollapsed }">
            <!-- Èù¢ÊùøÂ§¥ÈÉ® -->
            <div class="panel-header">
                <h3 class="panel-title">Ê†áÊ≥®ÁÆ°ÁêÜ</h3>
                <button class="close-btn" @click="togglePanel">‚úï</button>
            </div>

            <div class="panel-content">
                <!-- Ê£ÄÊµãÁõÆÊ†áÁ±ªÂà´ -->
                <div class="categories-section">
                    <div class="section-title">Ê£ÄÊµãÁõÆÊ†áÁ±ªÂà´</div>
                    <div
                        v-for="category in categories"
                        :key="category.id"
                        class="category-item"
                        :class="{ selected: selectedCategoryId === category.id }"
                        @click="selectCategory(category.id)"
                    >
                        <div class="category-info">
                            <div
                                class="category-color"
                                :style="{ background: category.color }"
                            ></div>
                            <span class="category-name">{{ category.name }}</span>
                        </div>
                        <div class="category-actions">
                            <span class="category-count">{{ getCategoryCount(category.id) }}</span>
                            <button
                                class="category-delete"
                                @click.stop="deleteCategory(category.id)"
                                :disabled="getCategoryCount(category.id) > 0"
                                title="Âà†Èô§Á±ªÂà´"
                            >
                                ‚úï
                            </button>
                        </div>
                    </div>

                    <!-- Ê∑ªÂä†Êñ∞Á±ªÂà´ -->
                    <div v-if="showAddCategory" class="add-category-form">
                        <div class="input-group">
                            <input
                                ref="categoryInput"
                                v-model="newCategoryName"
                                type="text"
                                placeholder="ËæìÂÖ•Á±ªÂà´ÂêçÁß∞ (‰ªÖÈôêËã±ÊñáÂ≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫ø)"
                                class="category-input"
                                :class="{ 'input-error': inputError }"
                                @keyup.enter="addCategory"
                                @keyup.esc="cancelAddCategory"
                                @input="validateCategoryName"
                                @keydown="restrictInput"
                            />
                        </div>
                        <div class="color-picker">
                            <div
                                v-for="color in presetColors"
                                :key="color"
                                class="color-option"
                                :class="{
                                    selected: newCategoryColor === color,
                                    used: isColorUsed(color),
                                }"
                                :style="{ background: color }"
                                @click="selectColor(color)"
                                :title="isColorUsed(color) ? 'ËØ•È¢úËâ≤Â∑≤Ë¢´‰ΩøÁî®' : ''"
                            ></div>
                        </div>
                        <div class="form-actions">
                            <button
                                class="btn-confirm"
                                @click="addCategory"
                                :disabled="!newCategoryName.trim() || isColorUsed(newCategoryColor)"
                            >
                                Á°ÆÂÆö
                            </button>
                            <button class="btn-cancel" @click="cancelAddCategory">ÂèñÊ∂à</button>
                        </div>
                    </div>

                    <button v-else class="add-category-btn" @click="startAddCategory">
                        + Ê∑ªÂä†Êñ∞Á±ªÂà´
                    </button>
                </div>

                <!-- ÂΩìÂâçÊ†áÊ≥®ÂàóË°® -->
                <div class="annotations-section">
                    <div class="section-title">
                        ÂΩìÂâçÊ†áÊ≥®ÂàóË°® ({{ annotations.length }})
                        <button
                            v-if="annotations.length > 0"
                            class="clear-all-btn"
                            @click="clearAllAnnotations"
                            title="Ê∏ÖÁ©∫ÊâÄÊúâÊ†áÊ≥®"
                        >
                            Ê∏ÖÁ©∫
                        </button>
                    </div>
                    <div class="annotation-list">
                        <div v-if="annotations.length === 0" class="empty-annotations">
                            ÊöÇÊó†Ê†áÊ≥®Êï∞ÊçÆ
                        </div>

                        <div
                            v-for="annotation in annotations"
                            :key="annotation.id"
                            class="annotation-item"
                            :class="{ selected: selectedAnnotationId === annotation.id }"
                            @click="selectAnnotation(annotation.id)"
                        >
                            <div class="annotation-header">
                                <div class="annotation-title">{{ annotation.title }}</div>
                                <button
                                    class="annotation-delete"
                                    @click.stop="deleteAnnotation(annotation.id)"
                                    title="Âà†Èô§Ê†áÊ≥®"
                                >
                                    ‚úï
                                </button>
                            </div>
                            <div class="annotation-coords">
                                <div class="annotation-text">
                                    X:{{ Math.round(annotation.x) }} Y:{{
                                        Math.round(annotation.y)
                                    }}
                                    W:{{ Math.round(annotation.width) }} H:{{
                                        Math.round(annotation.height)
                                    }}
                                </div>

                                <div
                                    class="category-colors"
                                    :style="{ background: getCategoryColor(annotation.categoryId) }"
                                ></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                <div class="stats-section">
                    <div class="section-title">ÁªüËÆ°‰ø°ÊÅØ</div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">{{ totalAnnotationsCount }}</div>
                            <div class="stat-label">ÂÖ®ÈÉ®Ê†áÊ≥®Êï∞</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ annotatedFilesCount }}</div>
                            <div class="stat-label">Â∑≤Ê†áÊ≥®ÂõæÁâá</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ categories.length }}</div>
                            <div class="stat-label">Ê†áÊ≥®Á±ªÂà´</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ allFiles.length }}</div>
                            <div class="stat-label">ÊÄªÂõæÁâáÊï∞</div>
                        </div>
                    </div>
                </div>

                <!-- Êï∞ÊçÆÂØºÂá∫ -->
                <div class="export-section">
                    <div class="section-title">Êï∞ÊçÆÂØºÂá∫</div>
                    <div class="export-buttons">
                        <button
                            v-for="format in exportFormats"
                            :key="format.id"
                            class="export-btn"
                            :class="{ primary: format.primary }"
                            @click="exportData(format.id)"
                            :disabled="format.loading || totalAnnotationsCount === 0"
                        >
                            <span v-if="format.loading" class="loading"></span>
                            {{ format.loading ? 'ÂØºÂá∫‰∏≠...' : format.name }}
                        </button>
                    </div>

                    <!-- ÂØºÂá∫ÈÄâÈ°π -->
                    <div class="export-options">
                        <label class="option-label">
                            <input type="checkbox" v-model="exportOptions.includeEmpty" />
                            ÂåÖÂê´Êó†Ê†áÊ≥®ÁöÑÂõæÁâá
                        </label>
                        <!-- <label class="option-label">
                            <input type="checkbox" v-model="exportOptions.normalizeCoords" />
                            ÂΩí‰∏ÄÂåñÂùêÊ†á (YOLOÊ†ºÂºè)
                        </label> -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
export default {
    name: 'PropertiesPanel',
    props: {
        isCollapsed: {
            type: Boolean,
            default: true,
        },
        categories: {
            type: Array,
            required: true,
        },
        annotations: {
            type: Array,
            required: true,
        },
        selectedAnnotationId: {
            type: [Number, String],
            default: null,
        },
        selectedCategoryId: {
            type: [Number, String],
            default: null,
        },
        allFiles: {
            type: Array,
            default: () => [],
        },
        allAnnotations: {
            type: Array,
            default: () => [],
        },
    },
    data() {
        return {
            showAddCategory: false,
            newCategoryName: '',
            newCategoryColor: '#dc2626',
            inputError: false,
            presetColors: [
                '#e11d48',
                '#f97316',
                '#eab308',
                '#22c55e',
                '#06b6d4',
                '#3b82f6',
                '#8b5cf6',
                '#ec4899',
                '#f59e0b',
                '#10b981',
                '#0ea5e9',
                '#a855f7',
                '#ef4444',
                '#84cc16',
                '#6366f1',
            ],
            exportFormats: [
                { id: 'txt', name: 'ÂØºÂá∫ TXT (YOLO)', primary: true, loading: false },
                { id: 'json', name: 'ÂØºÂá∫ JSON (COCO)', primary: false, loading: false },
                { id: 'xml', name: 'ÂØºÂá∫ XML (PASCAL VOC)', primary: false, loading: false },
            ],
            exportOptions: {
                includeEmpty: false,
                normalizeCoords: true,
            },
        };
    },
    computed: {
        totalAnnotationsCount() {
            return this.allAnnotations.length;
        },

        annotatedFilesCount() {
            const annotatedFileIds = new Set();
            this.allAnnotations.forEach(annotation => {
                if (annotation.fileId) {
                    annotatedFileIds.add(annotation.fileId);
                }
            });
            return annotatedFileIds.size;
        },
    },
    methods: {
        togglePanel() {
            this.$emit('toggle-panel');
        },

        selectCategory(categoryId) {
            this.$emit('category-selected', categoryId);
        },

        startAddCategory() {
            this.showAddCategory = true;
            this.newCategoryName = '';
            // ÈÄâÊã©Á¨¨‰∏Ä‰∏™Êú™Ë¢´‰ΩøÁî®ÁöÑÈ¢úËâ≤‰Ωú‰∏∫ÈªòËÆ§È¢úËâ≤
            this.newCategoryColor = this.getFirstUnusedColor();
            this.inputError = false;
            this.$nextTick(() => {
                if (this.$refs.categoryInput) {
                    this.$refs.categoryInput.focus();
                }
            });
        },

        cancelAddCategory() {
            this.showAddCategory = false;
            this.newCategoryName = '';
            this.inputError = false;
        },

        // Ëé∑ÂèñÁ¨¨‰∏Ä‰∏™Êú™Ë¢´‰ΩøÁî®ÁöÑÈ¢úËâ≤
        getFirstUnusedColor() {
            return (
                this.presetColors.find(color => !this.isColorUsed(color)) || this.presetColors[0]
            );
        },

        // Ê£ÄÊü•È¢úËâ≤ÊòØÂê¶Â∑≤Ë¢´‰ΩøÁî®
        isColorUsed(color) {
            return this.categories.some(cat => cat.color === color);
        },

        // ÈÄâÊã©È¢úËâ≤
        selectColor(color) {
            if (!this.isColorUsed(color)) {
                this.newCategoryColor = color;
            }
        },

        // ÈôêÂà∂ËæìÂÖ•ÔºöÂè™ÂÖÅËÆ∏Ëã±ÊñáÂ≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫ø
        restrictInput(event) {
            // ÂÖÅËÆ∏ÁöÑÁâπÊÆäÊåâÈîÆ
            const allowedKeys = [
                'Backspace',
                'Delete',
                'Tab',
                'Escape',
                'Enter',
                'ArrowLeft',
                'ArrowRight',
                'ArrowUp',
                'ArrowDown',
                'Home',
                'End',
                'Control',
                'Meta',
                'Alt',
                'Shift',
            ];

            // Â¶ÇÊûúÊòØÁâπÊÆäÊåâÈîÆÔºåÂÖÅËÆ∏ÈÄöËøá
            if (allowedKeys.includes(event.key)) {
                return;
            }

            // Â¶ÇÊûúÊòØÁªÑÂêàÈîÆÔºàCtrl+A, Ctrl+C, Ctrl+V Á≠âÔºâÔºåÂÖÅËÆ∏ÈÄöËøá
            if (event.ctrlKey || event.metaKey) {
                return;
            }

            // Ê£ÄÊü•ËæìÂÖ•Â≠óÁ¨¶ÊòØÂê¶Á¨¶ÂêàËßÑÂàôÔºöËã±ÊñáÂ≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫ø
            const regex = /^[a-zA-Z0-9_]$/;
            if (!regex.test(event.key)) {
                event.preventDefault();
                // ËÆæÁΩÆÁ∫¢Ëâ≤ËæπÊ°ÜÁä∂ÊÄÅ
                this.inputError = true;
                // 3ÁßíÂêéÊ∏ÖÈô§Á∫¢Ëâ≤ËæπÊ°Ü
                setTimeout(() => {
                    this.inputError = false;
                }, 3000);
                return;
            }
        },

        // È™åËØÅÁ±ªÂà´ÂêçÁß∞
        validateCategoryName() {
            const name = this.newCategoryName;

            // Ê∏ÖÈô§‰πãÂâçÁöÑÈîôËØØÁä∂ÊÄÅ
            this.inputError = false;

            if (!name) {
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ÈùûÊ≥ïÂ≠óÁ¨¶
            const regex = /^[a-zA-Z0-9_]*$/;
            if (!regex.test(name)) {
                this.inputError = true;
                return;
            }

            // Ê£ÄÊü•ÈïøÂ∫¶
            if (name.length > 50) {
                this.inputError = true;
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶‰ª•Êï∞Â≠óÂºÄÂ§¥
            if (/^\d/.test(name)) {
                this.inputError = true;
                return;
            }
        },

        addCategory() {
            const name = this.newCategoryName.trim();

            if (!name) {
                this.$emit('message', { type: 'warning', message: 'ËØ∑ËæìÂÖ•Á±ªÂà´ÂêçÁß∞' });
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ÈùûÊ≥ïÂ≠óÁ¨¶
            const regex = /^[a-zA-Z0-9_]+$/;
            if (!regex.test(name)) {
                this.$emit('message', {
                    type: 'error',
                    message: 'Á±ªÂà´ÂêçÁß∞Âè™ËÉΩÂåÖÂê´Ëã±ÊñáÂ≠óÊØç„ÄÅÊï∞Â≠óÂíå‰∏ãÂàíÁ∫ø',
                });
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶‰ª•Êï∞Â≠óÂºÄÂ§¥
            if (/^\d/.test(name)) {
                this.$emit('message', {
                    type: 'error',
                    message: 'Á±ªÂà´ÂêçÁß∞‰∏çËÉΩ‰ª•Êï∞Â≠óÂºÄÂ§¥',
                });
                return;
            }

            // Ê£ÄÊü•ÈïøÂ∫¶
            if (name.length > 50) {
                this.$emit('message', {
                    type: 'error',
                    message: 'Á±ªÂà´ÂêçÁß∞‰∏çËÉΩË∂ÖËøá50‰∏™Â≠óÁ¨¶',
                });
                return;
            }

            // Ê£ÄÊü•ÊòØÂê¶ÈáçÂêç
            if (this.categories.some(cat => cat.name === name)) {
                this.$emit('message', { type: 'warning', message: 'Á±ªÂà´ÂêçÁß∞Â∑≤Â≠òÂú®' });
                return;
            }

            // Ê£ÄÊü•È¢úËâ≤ÊòØÂê¶Ë¢´‰ΩøÁî®Ëøá
            if (this.isColorUsed(this.newCategoryColor)) {
                this.$emit('message', {
                    type: 'warning',
                    message: 'ËØ•È¢úËâ≤Â∑≤Ë¢´ÂÖ∂‰ªñÁ±ªÂà´‰ΩøÁî®ÔºåËØ∑ÈÄâÊã©ÂÖ∂‰ªñÈ¢úËâ≤',
                });
                return;
            }

            // ÁîüÊàê‰∏¥Êó∂IDÁî®‰∫éÁ´ãÂç≥ÈÄâÊã©ÔºàÁà∂ÁªÑ‰ª∂‰ºöÊõøÊç¢‰∏∫ÁúüÂÆûIDÔºâ
            const tempId = 'temp_' + Date.now();

            this.$emit('category-added', {
                tempId: tempId,
                name: name,
                color: this.newCategoryColor,
            });

            // Âª∂ËøüÈÄâÊã©Êñ∞Á±ªÂà´ÔºåÁ≠âÁà∂ÁªÑ‰ª∂Â§ÑÁêÜÂÆåÊàê
            this.$nextTick(() => {
                // Êü•ÊâæÂàöÊ∑ªÂä†ÁöÑÁ±ªÂà´ÔºàÈÄöËøáÂêçÁß∞ÂíåÈ¢úËâ≤ÂåπÈÖçÔºâ
                const newCategory = this.categories.find(
                    cat => cat.name === name && cat.color === this.newCategoryColor
                );
                if (newCategory) {
                    this.$emit('category-selected', newCategory.id);
                }
            });

            this.$emit('message', { type: 'success', message: 'Á±ªÂà´Ê∑ªÂä†ÊàêÂäüÂπ∂Â∑≤Ëá™Âä®ÈÄâÊã©' });
            this.cancelAddCategory();
        },

        async deleteCategory(categoryId) {
            const count = this.getCategoryCount(categoryId);
            if (count > 0) {
                this.$emit('message', {
                    type: 'warning',
                    message: `ËØ•Á±ªÂà´‰∏ãËøòÊúâ ${count} ‰∏™Ê†áÊ≥®ÔºåÊó†Ê≥ïÂà†Èô§`,
                });
                return;
            }

            try {
                await this.$confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Á±ªÂà´ÂêóÔºü', 'Âà†Èô§Á±ªÂà´');
                this.$emit('category-deleted', categoryId);
                this.$emit('message', { type: 'success', message: 'Á±ªÂà´Âà†Èô§ÊàêÂäü' });
            } catch (error) {
                // Áî®Êà∑ÂèñÊ∂àÂà†Èô§Ôºå‰∏çÈúÄË¶ÅÂ§ÑÁêÜ
            }
        },

        getCategoryCount(categoryId) {
            return this.annotations.filter(ann => ann.categoryId === categoryId).length;
        },

        getCategoryColor(categoryId) {
            const category = this.categories.find(cat => cat.id === categoryId);
            return category ? category.color : '#64748b';
        },

        selectAnnotation(annotationId) {
            this.$emit('annotation-selected', annotationId);
        },

        async deleteAnnotation(annotationId) {
            try {
                await this.$confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ê†áÊ≥®ÂêóÔºü', 'Âà†Èô§Ê†áÊ≥®');
                this.$emit('annotation-deleted', annotationId);
                this.$emit('message', { type: 'success', message: 'Ê†áÊ≥®Âà†Èô§ÊàêÂäü' });
            } catch (error) {
                // Áî®Êà∑ÂèñÊ∂àÂà†Èô§Ôºå‰∏çÈúÄË¶ÅÂ§ÑÁêÜ
            }
        },

        async clearAllAnnotations() {
            try {
                await this.$confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊ†áÊ≥®ÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ', 'Ê∏ÖÁ©∫Ê†áÊ≥®', {
                    type: 'error',
                });
                this.annotations.forEach(annotation => {
                    this.$emit('annotation-deleted', annotation.id);
                });
                this.$emit('message', { type: 'success', message: 'Â∑≤Ê∏ÖÁ©∫ÊâÄÊúâÊ†áÊ≥®' });
            } catch (error) {
                // Áî®Êà∑ÂèñÊ∂àÊìç‰ΩúÔºå‰∏çÈúÄË¶ÅÂ§ÑÁêÜ
            }
        },

        async exportData(formatId) {
            if (this.totalAnnotationsCount === 0) {
                this.$emit('message', { type: 'warning', message: 'Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑÊ†áÊ≥®Êï∞ÊçÆ' });
                return;
            }

            const hasUnlabeledImages = this.annotatedFilesCount < this.allFiles.length;

            if (hasUnlabeledImages && !this.exportOptions.includeEmpty) {
                const unlabeledCount = this.allFiles.length - this.annotatedFilesCount;
                try {
                    await this.$confirm(
                        `Ê£ÄÊµãÂà∞Êúâ ${unlabeledCount} Âº†ÂõæÁâáÂ∞öÊú™Ê†áÊ≥®ÔºåËøô‰∫õÂõæÁâáÂ∞Ü‰∏ç‰ºöÂåÖÂê´Âú®ÂØºÂá∫Êï∞ÊçÆ‰∏≠„ÄÇ
                        <br/>Â¶ÇÈúÄÂåÖÂê´ÊâÄÊúâÂõæÁâáÔºåËØ∑ÂãæÈÄâ"ÂåÖÂê´Êó†Ê†áÊ≥®ÁöÑÂõæÁâá"ÈÄâÈ°π„ÄÇ
                        <br/>Á°ÆÂÆöË¶ÅÁªßÁª≠ÂØºÂá∫ÂêóÔºü`,
                        'Êú™ÂÆåÊàêÊ†áÊ≥®ÊèêÈÜí',
                        {
                            type: 'warning',
                            dangerouslyUseHTMLString: true,
                            confirmButtonText: 'ÁªßÁª≠ÂØºÂá∫',
                            cancelButtonText: 'ÂèñÊ∂à',
                            showClose: false,
                            closeOnClickModal: false,
                        }
                    );
                } catch (error) {
                    // Áî®Êà∑ÂèñÊ∂àÂØºÂá∫
                    return;
                }
            }

            const format = this.exportFormats.find(f => f.id === formatId);
            if (!format || format.loading) return;

            format.loading = true;

            try {
                await new Promise(resolve => setTimeout(resolve, 1000));
                this.$emit('export', {
                    format: formatId,
                    options: this.exportOptions,
                });
                this.$emit('message', { type: 'success', message: `${format.name} ÂØºÂá∫ÊàêÂäü` });
            } catch (error) {
                this.$emit('message', { type: 'error', message: `${format.name} ÂØºÂá∫Â§±Ë¥•` });
            } finally {
                format.loading = false;
            }
        },
    },
    mounted() {
        const handleEscKey = e => {
            if (e.key === 'Escape') {
                if (this.showAddCategory) {
                    this.cancelAddCategory();
                } else if (!this.isCollapsed) {
                    this.togglePanel();
                }
            }
        };

        document.addEventListener('keydown', handleEscKey);
        this.$once('hook:beforeDestroy', () => {
            document.removeEventListener('keydown', handleEscKey);
        });
    },
};
</script>

<style type="scss" scoped>
/* ÊäòÂè†Áä∂ÊÄÅÁöÑÂ±ûÊÄßÈù¢Êùø - ÁÆÄÊ¥ÅÈ£éÊ†º */
.properties-collapsed {
    position: fixed;
    top: 60px;
    right: 0;
    width: 60px;
    height: calc(100vh - 60px);
    background: #ffffff;
    border-left: 1px solid #e2e8f0;
    box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    cursor: pointer;
    transition: all 0.3s ease;
    overflow: hidden;
}

.collapsed-content {
    padding: 20px 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    position: relative;
}

/* ÊäòÂè†Áä∂ÊÄÅÂõæÊ†á */
.collapsed-icon {
    font-size: 20px;
    margin-bottom: 20px;
    color: #64748b;
}

/* ÊäòÂè†Áä∂ÊÄÅÁ±ªÂà´ÂàóË°® - ÂÆåÊï¥ÂêçÁß∞Áâà */
.collapsed-categories {
    flex: 1;
    width: 100%;
    max-height: 790px; /* ÈôêÂà∂ÊúÄÂ§ßÈ´òÂ∫¶ */
    overflow-y: auto; /* ÂÜÖÂÆπË∂ÖÂá∫Êó∂ÊòæÁ§∫ÊªöÂä®Êù° */
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 20px;
    padding: 0 2px;

    /* Ëá™ÂÆö‰πâÊªöÂä®Êù°Ê†∑Âºè */
    &::-webkit-scrollbar {
        width: 3px;
    }

    &::-webkit-scrollbar-track {
        background: rgba(241, 245, 249, 0.5);
        border-radius: 2px;
    }

    &::-webkit-scrollbar-thumb {
        background: rgba(203, 213, 225, 0.8);
        border-radius: 2px;

        &:hover {
            background: rgba(148, 163, 184, 0.9);
        }
    }

    .collapsed-category-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 6px 4px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        min-height: 44px;
        flex-shrink: 0;

        &:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        &.active {
            background: rgba(59, 130, 246, 0.15);

            .collapsed-category-name {
                color: #3b82f6;
                font-weight: 600;
            }
        }

        .collapsed-category-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        .collapsed-category-name {
            font-size: 9px;
            font-weight: 500;
            color: #475569;
            text-align: center;
            line-height: 1.1;
            word-break: break-all; /* ÂÖÅËÆ∏ÈïøÂçïËØçÊç¢Ë°å */
            hyphens: auto; /* Ëá™Âä®ËøûÂ≠óÁ¨¶ */
            max-width: 40px; /* ÈôêÂà∂ÊúÄÂ§ßÂÆΩÂ∫¶ */
            overflow-wrap: break-word; /* Âº∫Âà∂Êç¢Ë°å */
        }
    }
}

/* ÊäòÂè†Áä∂ÊÄÅÁªüËÆ° */
.collapsed-stats {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: auto;

    .stat-item {
        width: 32px;
        height: 32px;
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;

        .stat-number {
            font-size: 12px;
            font-weight: 700;
            color: #334155;
            line-height: 1;
        }

        .stat-text {
            font-size: 8px;
            color: #64748b;
            font-weight: 500;
            margin-top: 1px;
        }
    }
}

/* Â±ïÂºÄÁä∂ÊÄÅÁöÑÈù¢Êùø */
.properties-expanded {
    position: fixed;
    top: 60px;
    right: -350px;
    width: 350px;
    height: calc(100vh - 60px);
    background: #ffffff;
    border-left: 1px solid #e2e8f0;
    box-shadow: -8px 0 20px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
    z-index: 1001;
    overflow: hidden;
}

.properties-expanded.open {
    right: 60px;
}

/* Èù¢ÊùøÂ§¥ÈÉ® */
.panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
}

.panel-title {
    font-size: 16px;
    font-weight: 600;
    margin: 0;
    color: #1e293b;
}

.close-btn {
    width: 32px;
    height: 32px;
    background: transparent;
    border: none;
    color: #64748b;
    cursor: pointer;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.close-btn:hover {
    background: #f1f5f9;
    color: #334155;
}

/* Èù¢ÊùøÂÜÖÂÆπ */
.panel-content {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

.categories-section,
.annotations-section,
.stats-section,
.export-section {
    padding: 20px;
    border-bottom: 1px solid #e2e8f0;
}

.section-title {
    font-weight: 600;
    margin-bottom: 16px;
    color: #1e293b;
    font-size: 15px;
    padding-bottom: 8px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.clear-all-btn {
    background: none;
    border: 1px solid #e2e8f0;
    color: #64748b;
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.clear-all-btn:hover {
    background: #fee2e2;
    border-color: #fca5a5;
    color: #dc2626;
}

.category-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    margin: 6px 0;
    background: #ffffff;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
    transition: all 0.2s ease;
    cursor: pointer;
    box-sizing: border-box;
}

.category-item:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
}

.category-item.selected {
    box-sizing: border-box;
    background: #f0f9ff;
    border-color: #3b82f6;
}

.category-info {
    display: flex;
    align-items: center;
    flex: 1;
}

.category-color {
    width: 16px;
    height: 16px;
    border-radius: 3px;
    margin-right: 10px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    flex-shrink: 0;
}
.annotation-coords {
    margin-bottom: 4px;
    display: flex;
    justify-content: space-between;
}
.category-colors {
    margin-right: 1px;
    justify-content: space-between;
    width: 16px;
    height: 16px;
    border-radius: 3px;
    /* margin-right: 10px; */
    border: 1px solid rgba(0, 0, 0, 0.1);
    /* flex-shrink: 0; */
}
.annotation-text {
    font-size: 11px;
    color: #64748b;
    font-family: 'Consolas', monospace;
    text-align: center;
    line-height: 16px;
}

.category-name {
    font-weight: 500;
    font-size: 14px;
    color: #334155;
}

.category-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.category-count {
    font-size: 12px;
    color: #64748b;
    background: #f1f5f9;
    padding: 2px 8px;
    border-radius: 12px;
    min-width: 24px;
    text-align: center;
}

.category-delete {
    background: none;
    border: none;
    color: #64748b;
    cursor: pointer;
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 3px;
    transition: all 0.2s ease;
}

.category-delete:hover:not(:disabled) {
    background: #fee2e2;
    color: #dc2626;
}

.category-delete:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

/* Ê∑ªÂä†Á±ªÂà´Ë°®Âçï */
.add-category-form {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 16px;
    margin: 12px 0;
}

.input-group {
    margin-bottom: 12px;
}

.category-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
    outline: none;
    transition: all 0.2s ease;
}

.category-input:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.category-input.input-error {
    border-color: #dc2626;
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
}

.color-picker {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 12px;
}

.color-option {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s ease;
    position: relative;
}

.color-option.selected {
    border-color: #334155;
    transform: scale(1.1);
}

.color-option.used {
    cursor: not-allowed;
    opacity: 0.5;
    position: relative;
}

.color-option.used::before {
    content: '‚úï';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-weight: bold;
    font-size: 12px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
}

.form-actions {
    display: flex;
    gap: 8px;
}

.btn-confirm,
.btn-cancel {
    flex: 1;
    padding: 8px 16px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
}

.btn-confirm {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.btn-confirm:enabled:hover {
    background: #2563eb;
}

.btn-confirm:disabled {
    background: #94a3b8;
    border-color: #94a3b8;
    cursor: not-allowed;
    opacity: 0.6;
}

.btn-cancel {
    background: white;
    color: #64748b;
}

.btn-cancel:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
}

.add-category-btn {
    width: 100%;
    padding: 12px;
    background: #f8fafc;
    color: #64748b;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
    margin-top: 12px;
    font-size: 14px;
}

.add-category-btn:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
    color: #334155;
}

.annotation-list {
    box-sizing: border-box;
    max-height: 300px;
    overflow-y: auto;
}

.empty-annotations {
    text-align: center;
    color: #64748b;
    font-style: italic;
    padding: 20px;
}

.annotation-item {
    box-sizing: border-box;
    background: #ffffff;
    padding: 12px;
    margin: 8px 0;
    border-radius: 6px;
    border: 1px solid #e2e8f0;
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative;
}

.annotation-item:hover {
    box-sizing: border-box;
    background: #f8fafc;
    border-color: #cbd5e1;
}

.annotation-item.selected {
    box-sizing: border-box;
    background: #f0f9ff;
    border-color: #3b82f6;
    box-sizing: border-box;
}

.annotation-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.annotation-title {
    font-weight: 500;
    font-size: 14px;
    color: #334155;
}

.annotation-delete {
    background: none;
    border: none;
    color: #64748b;
    cursor: pointer;
    font-size: 12px;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.annotation-delete:hover {
    background: #fee2e2;
    color: #dc2626;
}

.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.stats-section .stat-item {
    text-align: center;
    padding: 16px;
    background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    transition: all 0.2s ease;
}

.stats-section .stat-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.stat-value {
    font-size: 24px;
    font-weight: 700;
    color: #334155;
    margin-bottom: 4px;
}

.stat-label {
    font-size: 12px;
    color: #64748b;
}

.export-buttons {
    display: flex;
    gap: 12px;
    flex-direction: column;
    margin-bottom: 16px;
}

.export-btn {
    padding: 12px;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
    background: #ffffff;
    color: #334155;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.export-btn:hover:not(:disabled) {
    background: #f8fafc;
    border-color: #cbd5e1;
}

.export-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.export-btn.primary {
    background: #3b82f6;
    color: white;
    border-color: #3b82f6;
}

.export-btn.primary:hover:not(:disabled) {
    background: #2563eb;
}

.export-options {
    border-top: 1px solid #e2e8f0;
    padding-top: 16px;
    margin-top: 16px;
}

.option-label {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    font-size: 14px;
    color: #334155;
    cursor: pointer;
}

.option-label input {
    margin-right: 8px;
}

.loading {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #e2e8f0;
    border-radius: 50%;
    border-top-color: #3b82f6;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* ÊªöÂä®Êù°Ê†∑Âºè */
.annotation-list::-webkit-scrollbar,
.panel-content::-webkit-scrollbar {
    width: 4px;
}

.annotation-list::-webkit-scrollbar-track,
.panel-content::-webkit-scrollbar-track {
    background: #f1f5f9;
}

.annotation-list::-webkit-scrollbar-thumb,
.panel-content::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 2px;
}

@media (max-width: 768px) {
    .properties-collapsed {
        width: 50px;
    }

    .properties-expanded {
        width: calc(100% - 50px);
        right: -100%;
    }

    .properties-expanded.open {
        right: 50px;
    }

    .collapsed-category-dot {
        width: 16px;
        height: 16px;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }
}
</style>
